pipeline {
    agent {
        docker {
            image 'python:3.12-slim'
        }
    }

    triggers {
        cron('0 12 * * *')
    }

    stages {
        stage('Generate payload and trigger downstream') {
            steps {
                script {
                    String payloadFile = 'payload.json'
                    sh "python3 pipeline-child/script/payload.py ${payloadFile}"

                    if (!fileExists(payloadFile)) {
                        error("payload file not found: ${payloadFile}")
                    }

                    def payloadList = readJSON file: payloadFile
                    if (!(payloadList instanceof Collection)) {
                        error('payload.py output must be a JSON list')
                    }
                    if (payloadList.isEmpty()) {
                        echo 'payload list is empty; no downstream builds triggered'
                        return
                    }

                    payloadList.eachWithIndex { item, idx ->
                        if (!(item instanceof Map)) {
                            error("payload index ${idx} must be an object")
                        }

                        ['title', 'name', 'value'].each { key ->
                            if (!item.containsKey(key)) {
                                error("payload index ${idx} is missing key: ${key}")
                            }
                        }

                        build(
                            job: 'pipeline-child-downstream',
                            wait: true,
                            parameters: [
                                string(name: 'title', value: "${item.title}"),
                                string(name: 'name', value: "${item.name}"),
                                string(name: 'value', value: "${item.value}")
                            ]
                        )
                    }
                }
            }
        }
    }
}
