pipeline {
  agent any

  stages {
    stage('Run random-csv job') {
      steps {
        script {
          String randomCsvJob = 'random-csv'
          def randomBuild = build job: randomCsvJob, wait: true
          copyArtifacts(
            projectName: randomCsvJob,
            selector: specific("${randomBuild.number}"),
            filter: 'random_numbers.csv'
          )

          String n = sh(
            script: "awk 'NR==2{print $1}' random_numbers.csv",
            returnStdout: true
          ).trim()
          if (!n) {
            error('random_numbers.csv に数値がありません')
          }
          env.INPUT_NUMBER = n
        }
      }
    }

    stage('Run multiply-param job') {
      steps {
        script {
          String multiplyJob = 'multiply-param'
          build job: multiplyJob, wait: true, parameters: [
            string(name: 'INPUT_NUMBER', value: env.INPUT_NUMBER)
          ]
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'random_numbers.csv', onlyIfSuccessful: false
    }
  }
}
