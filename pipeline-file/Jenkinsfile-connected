pipeline {
  agent any

  stages {
    stage('Run random-csv job') {
      environment {
        JOB_NAME = 'random-csv'
        OUTPUT_FILE_NAME = 'random_numbers.csv'
      }
      steps {
        script {
          // Trigger the upstream job that generates the CSV artifact.
          def job = build job: env.JOB_NAME, wait: true

          // Pull the CSV from the specific build we just ran.
          copyArtifacts(
            projectName: env.JOB_NAME,
            selector: specific("${job.number}"),
            filter: env.OUTPUT_FILE_NAME
          )
        }
      }
    }
    stage('csv validation') {
      environment {
        EXPECTED_HEADER = 'number'
      }
      steps {
        script {
          def status = sh(
            script: 'head -n 1 file.csv | grep -qx "$EXPECTED_HEADER"',
            returnStatus: true
          )
          if (status != 0) {
            error("CSV headerが不正です。期待値: ${env.EXPECTED_HEADER}")
          }

          // Read the CSV file and extract the first number after the header.
          def csvContent = readFile('random_numbers.csv').trim().split('\n')
          if (csvContent.length < 1) {
            error "CSV file does not contain enough data."
          }
        }
      }
    }

    stage('Run multiply-param job') {
      steps {
        script {
          sh('''
            echo "Downloaded random_numbers.csv:"
            cat random_numbers.csv
          ''')

          // Trigger the downstream job with the extracted parameter.
          String multiplyJob = 'multiply-param'
          build job: multiplyJob, wait: true, parameters: [
            string(name: 'INPUT_NUMBER', value: env.INPUT_NUMBER)
          ]
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'random_numbers.csv', onlyIfSuccessful: false
    }
  }
}
